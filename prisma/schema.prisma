// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

enum RecurringType {
  EXPENSE
  INCOME
}

enum Frequency {
  WEEKLY
  MONTHLY
  YEARLY
}

model Category {
  id                 Int                 @id @default(autoincrement())
  name               String              @unique @db.VarChar(100)
  color              String?             @db.VarChar(7)
  createdAt          DateTime            @default(now()) @map("created_at")
  expenses           Expense[]
  recurringTemplates RecurringTemplate[]

  @@map("categories")
}

model Expense {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  description String?
  amount      Decimal  @db.Decimal(10, 2)
  categoryId  Int      @map("category_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  category    Category @relation(fields: [categoryId], references: [id])

  // Recurring transaction fields
  recurringTemplateId Int?               @map("recurring_template_id")
  recurringTemplate   RecurringTemplate? @relation(fields: [recurringTemplateId], references: [id])
  isAutoGenerated     Boolean            @default(false) @map("is_auto_generated")

  @@map("expenses")
}

model Income {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  description String?
  amount      Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Recurring transaction fields
  recurringTemplateId Int?               @map("recurring_template_id")
  recurringTemplate   RecurringTemplate? @relation(fields: [recurringTemplateId], references: [id])
  isAutoGenerated     Boolean            @default(false) @map("is_auto_generated")

  @@map("incomes")
}

model RecurringTemplate {
  id          Int           @id @default(autoincrement())
  type        RecurringType
  amount      Decimal       @db.Decimal(10, 2)
  description String?
  categoryId  Int?          @map("category_id") // Only for expenses
  category    Category?     @relation(fields: [categoryId], references: [id])
  frequency   Frequency
  interval    Int           @default(1) // Every X weeks/months/years
  startDate   DateTime      @map("start_date") @db.Date
  endDate     DateTime?     @map("end_date") @db.Date // For installments
  nextDueDate DateTime      @map("next_due_date") @db.Date
  isActive    Boolean       @default(true) @map("is_active")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations to generated transactions
  expenses Expense[]
  incomes  Income[]

  @@map("recurring_templates")
}
