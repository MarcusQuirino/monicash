# Vercel Cron Job Setup for Recurring Transactions

## Overview

This project uses Vercel Cron Jobs to automatically generate recurring transactions daily at midnight (00:00 UTC).

## Configuration

### 1. vercel.json Configuration

The `vercel.json` file in the project root contains the cron job configuration:

```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "crons": [
    {
      "path": "/api/recurring-templates/generate",
      "schedule": "0 0 * * *"
    }
  ]
}
```

- **path**: The API endpoint that will be called
- **schedule**: Cron expression for daily execution at midnight UTC
  - Format: `minute hour day-of-month month day-of-week`
  - `0 0 * * *` means: at minute 0 of hour 0 (midnight) every day

### 2. Security (Optional)

For additional security, you can set up a `CRON_SECRET` environment variable:

1. **In your local `.env` file:**

   ```
   CRON_SECRET="your-secure-random-string-here"
   ```

2. **In Vercel Dashboard:**
   - Go to your project settings
   - Navigate to Environment Variables
   - Add `CRON_SECRET` with a secure random value

3. **Test the secured endpoint:**
   ```bash
   curl -X GET http://localhost:3000/api/recurring-templates/generate \
   -H "Authorization: Bearer your-secure-random-string-here"
   ```

## How It Works

1. **Daily Execution**: Every day at midnight UTC, Vercel automatically calls the `/api/recurring-templates/generate` endpoint
2. **Template Processing**: The endpoint finds all active recurring templates that are due for generation
3. **Transaction Creation**: For each due template, it creates a new expense or income record
4. **Next Due Date Update**: After creating a transaction, it calculates and updates the next due date for the template

## Vercel Plan Requirements

- **Hobby Plan**: 2 cron jobs maximum, triggered once daily
- **Pro Plan**: 40 cron jobs maximum, unlimited invocations
- **Enterprise Plan**: 100 cron jobs maximum, unlimited invocations

## Testing

### Manual Testing

You can manually trigger the cron job endpoint for testing:

```bash
# Test the auto-generation endpoint
curl -X GET http://localhost:3000/api/recurring-templates/generate

# With authentication (if CRON_SECRET is set)
curl -X GET http://localhost:3000/api/recurring-templates/generate \
-H "Authorization: Bearer your-cron-secret"
```

### Manual Single Template Generation

You can also generate transactions for specific templates:

```bash
curl -X POST http://localhost:3000/api/recurring-templates/generate \
-H "Content-Type: application/json" \
-d '{"templateId": 1}'
```

## Deployment

**Important**: Cron jobs only work in production deployments. Make sure to deploy your project to production:

```bash
vercel deploy --prod
```

After deployment, the cron job will automatically start running according to the schedule.

## Monitoring

You can monitor cron job executions in:

1. **Vercel Dashboard**: Check the Functions tab for execution logs
2. **Application Logs**: The endpoint logs successful generations and errors
3. **Database**: Verify that new transactions are being created with `isAutoGenerated: true`

## Troubleshooting

1. **Cron not running**: Ensure you've deployed to production (`vercel deploy --prod`)
2. **Unauthorized errors**: Check that `CRON_SECRET` is properly set in environment variables
3. **No transactions generated**: Verify that you have active recurring templates with due dates in the past
4. **Timezone issues**: Remember that cron jobs run in UTC timezone
